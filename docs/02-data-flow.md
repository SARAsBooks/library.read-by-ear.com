# Data Flow Guide

> **⚠️ LLM-Generated Documentation Disclaimer**: This documentation was generated by an AI language model and has not yet been edited or verified by the Sara's Books team. While efforts have been made to ensure accuracy, please verify code examples and file paths before use. Report any issues or inaccuracies to the development team.

This document shows how data moves through the app in both local and sync (Convex) modes.

## ASCII overview

```
+-------------------------+        +-------------------+
|         UI (React)      |  use*  |  ConvexProvider   |
|  src/app, src/components|<------>|  client & hooks   |
+-----------+-------------+        +---------+---------+
            | Legend observables (reactive)
            v
      +-----+-------------------------+
      |  Legend/state observables     |
      |  session$, library$, store$   |
      |  src/frontend/observable/*    |
      +-----+--------------+----------+
            |              |
            | persist      | larger local data
            v              v
   +--------+----+   +-----+--------------------+
   | localStorage|   | Dexie (IndexedDB)        |
   | Legend plug |   | src/frontend/dexie/*     |
   +-------------+   +-----------+--------------+
                                 |
                                 | sync/migrate
                                 v
                         +-------+--------+
                         | Convex (working|
                         | set, realtime) |
                         | convex/*       |
                         +---+--------+---+
                             |        |
                       queries|        |mutations
                             v        v
                   +---------+--------+-------------+
                   |  Next.js API / Server Actions  |
                   |  (audit, sessions, helpers)    |
                   |  src/app/api/*, src/backend/*  |
                   +----------------+---------------+
                                    |
                                    | Drizzle ORM
                                    v
                            +-------+--------------+
                            |   PostgreSQL (audit) |
                            |   reader_response    |
                            +----------------------+
```

## Modes

- Local mode

  - `session.saveProgress === "local"`
  - `library$` persists via localStorage; Dexie caches assets
  - No Convex required

- Sync (Convex) mode
  - `session.saveProgress === "sync"` and `session.useConvex === true` (and `NEXT_PUBLIC_CONVEX_URL`)
  - Reads via Convex queries; writes via Convex mutations
  - Background audit POSTs to Next.js API persist append-only records via Drizzle

## Where to look

- **Observables**: [`src/frontend/observable/sessions.ts`](../src/frontend/observable/sessions.ts), [`librarys.ts`](../src/frontend/observable/librarys.ts), [`stores.ts`](../src/frontend/observable/stores.ts)
- **Local persistence**: [`src/frontend/dexie/db.ts`](../src/frontend/dexie/db.ts), [`cached-assets.ts`](../src/frontend/dexie/cached-assets.ts)
- **API Routes**: [`src/app/api/`](../src/app/api/) - ping, session, errors, learning-audit, convex/token, student/new
- **Convex schema & functions**: [`convex/schema.ts`](../convex/schema.ts), [`convex/library.ts`](../convex/library.ts), [`convex/learning.ts`](../convex/learning.ts), [`convex/preferences.ts`](../convex/preferences.ts)
- **Convex client & hooks**: [`src/components/ConvexProvider.tsx`](../src/components/ConvexProvider.tsx), [`src/lib/convex/client.ts`](../src/lib/convex/client.ts), [`src/lib/convex/hooks.ts`](../src/lib/convex/hooks.ts), [`src/lib/convex/sync.ts`](../src/lib/convex/sync.ts)
- **Audit (Drizzle + Postgres)**: [`src/backend/db/schema.ts`](../src/backend/db/schema.ts), [`src/backend/db/fluency-records.ts`](../src/backend/db/fluency-records.ts)

---

**Previous**: [Onboarding Tutorial](./01-onboarding-tutorial.md) | **Next**: [Convex Primer](./03-convex-primer.md)
