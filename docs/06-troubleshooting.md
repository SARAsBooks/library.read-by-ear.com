# Troubleshooting

> **⚠️ LLM-Generated Documentation Disclaimer**: This documentation was generated by an AI language model and has not yet been edited or verified by the Sara's Books team. While efforts have been made to ensure accuracy, please verify code examples and file paths before use. Report any issues or inaccuracies to the development team.

## Convex not being used

- Symptom: `useQuery` returns undefined; logs show "Convex not available".
- Checks:
  - Ensure `NEXT_PUBLIC_CONVEX_URL` is set in your env.
  - Ensure `session.saveProgress === "sync"` and `session.useConvex === true`.
  - Confirm `ConvexProvider` is mounted at the app root.

## Token errors

- Symptom: Requests fail with auth errors.
- Checks:
  - The dev token endpoint [`/api/convex/token`](../src/app/api/convex/token/route.ts) should respond with `{ token }`.
  - Production must integrate real JWT from `auth.sara.ai`.

**Real code from the endpoint**:

```typescript
// From src/app/api/convex/token/route.ts - Development only!
function generateDevelopmentToken(
  studentId: string,
  sessionId?: string,
): string {
  const payload = {
    sub: studentId,
    sessionId: sessionId,
    iss: "read-by-ear-dev",
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + 3600, // 1 hour
  };
  return btoa(JSON.stringify(payload)); // NOT secure for production
}
```

## Dexie cache confusion

- Symptom: Old assets stick around.
- Tip: Check [`src/frontend/dexie/cached-assets.ts`](../src/frontend/dexie/cached-assets.ts) cleanup limits (sessions, days, max assets).
- You can clear IndexedDB via browser devtools (Application → Storage).

## Drizzle connection issues

- Symptom: DB calls fail during audit.
- Checks:
  - `DATABASE_URL` is set and accessible.
  - Network/firewall allows connections.
  - Run `npm run db:studio` to validate connectivity.

## Session mismatches

- Symptom: Local and server session states diverge.
- Tip: See merge logic in [`src/frontend/observable/sessions.ts`](../src/frontend/observable/sessions.ts) where it reconciles with server session.

## API endpoint errors

### Error reporting disabled (403)

- Symptom: `/api/errors` returns 403 "Error reporting disabled"
- Check: Environment configuration in [`src/lib/config/environment.ts`](../src/lib/config/environment.ts) has `enableErrorReporting: false`

### Learning audit validation errors (400)

- Symptom: `/api/learning-audit` returns "Invalid request" or "Invalid record format"
- Check: Ensure request body matches expected format:

```typescript
// Expected format from src/app/api/learning-audit/route.ts
{
  records: FluencyRecord[], // Array of learning records
  studentId: string,        // Required student ID
  source?: string          // Optional source identifier
}
```

### Database connection failures (500)

- Symptom: API calls fail with database errors
- Checks:
  - `DATABASE_URL` environment variable is set correctly
  - PostgreSQL is running and accessible
  - Run `npm run db:studio` to test Drizzle connectivity
  - Check [`src/backend/db/fluency-records.ts`](../src/backend/db/fluency-records.ts) for specific error messages

---

**Previous**: [Hands-on Exercises](./05-hands-on-exercises.md)
