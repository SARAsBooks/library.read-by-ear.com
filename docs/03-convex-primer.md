# Convex Primer for Read-by-Ear

> **⚠️ LLM-Generated Documentation Disclaimer**: This documentation was generated by an AI language model and has not yet been edited or verified by the Sara's Books team. While efforts have been made to ensure accuracy, please verify code examples and file paths before use. Report any issues or inaccuracies to the development team.

Convex provides a typed, realtime backend (“functions + database”) that pairs well with React.

## Core pieces in this repo

- **Schema**: [`convex/schema.ts`](../convex/schema.ts)
- **Queries/mutations**: [`convex/library.ts`](../convex/library.ts), [`convex/learning.ts`](../convex/learning.ts), [`convex/preferences.ts`](../convex/preferences.ts)
- **Generated API**: `convex/_generated/*` (consumed by React hooks)
- **React client integration**: [`src/components/ConvexProvider.tsx`](../src/components/ConvexProvider.tsx), [`src/lib/convex/client.ts`](../src/lib/convex/client.ts)
- **React hooks**: [`src/lib/convex/hooks.ts`](../src/lib/convex/hooks.ts)

## Schema and indexes

In [`convex/schema.ts`](../convex/schema.ts), tables are defined with strong runtime validation via `v`:

**Real example from the codebase**:

```typescript
// From convex/schema.ts
export default defineSchema({
  libraries: defineTable({
    studentId: v.string(),
    bookmarks: v.array(
      v.object({
        readingId: v.string(),
        currentPage: v.number(),
        lastupdate: v.number(), // timestamp
        completed: v.optional(v.boolean()),
        stars: v.optional(v.number()),
      }),
    ),
    library: v.array(v.string()), // reading IDs
    resumeReadings: v.optional(v.array(v.string())),
    clientOptions: v.optional(v.any()), // future use
  }).index("by_student", ["studentId"]),

  learningRecords: defineTable({
    studentId: v.string(),
    word: v.string(),
    responses: v.array(v.number()), // ResponseId enum values
    updatedAt: v.number(), // timestamp
  })
    .index("by_student", ["studentId"])
    .index("by_student_word", ["studentId", "word"]),
});
```

Indexes enable efficient `.withIndex("by_student", ...)` queries.

## Functions: queries and mutations

- Queries (`query`) are read-only.
- Mutations (`mutation`) write/update records.

Example: [`convex/library.ts:addBookmark`](../convex/library.ts) upserts a bookmark for a student. Example: [`convex/learning.ts`](../convex/learning.ts) includes rich flows for adding responses and syncing from Dexie, plus background audit POSTs to [`/api/learning-audit`](../src/app/api/learning-audit/route.ts).

## React integration

- The Convex React client is created in [`src/lib/convex/client.ts`](../src/lib/convex/client.ts) and configured with `ConvexProvider` in [`src/components/ConvexProvider.tsx`](../src/components/ConvexProvider.tsx).
- [`src/lib/convex/hooks.ts`](../src/lib/convex/hooks.ts) uses the generated `api.*` to expose `useQuery`/`useMutation` hooks.
- Timestamps are adapted (number ↔ Date) in hooks when needed.

## Auth

- [`convex/auth.config.ts`](../convex/auth.config.ts) documents the intended provider (auth.sara.ai) and JWKS.
- A dev token endpoint exists at [`src/app/api/convex/token/route.ts`](../src/app/api/convex/token/route.ts). Replace with real JWT signing in production.

## When does the app use Convex?

- If `NEXT_PUBLIC_CONVEX_URL` is set, and session preferences opt-in (`useConvex` with `saveProgress === "sync"`), Convex is used via helpers in [`src/lib/convex/sync.ts`](../src/lib/convex/sync.ts).
- Otherwise, the app falls back to legacy server actions/local persistence.

## Debugging tips

- Ensure `NEXT_PUBLIC_CONVEX_URL` is set; otherwise, `isConvexAvailable()` is false and hooks return undefined.
- Watch network tab for [`/api/convex/token`](../src/app/api/convex/token/route.ts) calls.
- For learning flows, check the background audit POSTs to [`/api/learning-audit`](../src/app/api/learning-audit/route.ts) in your dev console.

---

**Previous**: [Data Flow Guide](./02-data-flow.md) | **Next**: [API Tutorial](./04-api-tutorial.md)
