# Read-by-Ear Onboarding Tutorial

> **⚠️ LLM-Generated Documentation Disclaimer**: This documentation was generated by an AI language model and has not yet been edited or verified by the Sara's Books team. While efforts have been made to ensure accuracy, please verify code examples and file paths before use. Report any issues or inaccuracies to the development team.

This tutorial orients a junior React/Next.js developer (new to Convex) to the Read-by-Ear codebase. You’ll learn the project layout, data flow, state patterns, and how to add a small feature end-to-end.

## Quick start

- Requirements: Node 18+, npm (or pnpm), macOS okay. Optional: PostgreSQL if exploring Drizzle audit.
- Environment variables:
  - DATABASE_URL (for Drizzle audit features)
  - NEXT_PUBLIC_CONVEX_URL (optional; enables Convex paths)

Run locally:

```bash
# Install deps
npm install

# Dev server
npm run dev

# Production preview
npm run preview
```

Useful scripts (see package.json):

- build: next build
- dev: next dev --turbo
- start: next start
- check: lint + typecheck + prettier
- test: vitest
- db:\*: drizzle migrations and studio

## Big picture architecture

Local-first with progressive sync:

- UI: React app dir (Next.js) under `src/app/` and components under `src/components/`
- State: Legend/state observables under `src/frontend/observable/`
- Client persistence: localStorage via Legend persist and IndexedDB via Dexie under `src/frontend/dexie/`
- Server: Next.js server actions and API routes (audit, sessions); Drizzle ORM for Postgres in `src/backend/db/`
- Realtime/backed working set: Convex in `convex/` with client utilities in `src/lib/convex/`
- Feature flags choose local vs sync (Convex)

Key concept: “working set” vs “audit trail”

- Working set: Live data your UI reads/writes (Convex tables) with realtime/reactive queries
- Audit trail: Append-only analytics/records in Postgres via Drizzle

## Repo tour

- Root
  - `package.json` scripts and deps
  - `eslint.config.js`, `tsconfig.json`, `tailwind` config
  - `convex/` Convex schema + functions + generated API
  - `docs/` Documentation like this tutorial
- Backend (Next.js server actions / API)
  - [`src/app/api/`](../src/app/api/) Next.js API routes (ping, session, errors, learning-audit, convex/token, student/new)
  - [`src/backend/db/`](../src/backend/db/) Drizzle config and schema (`reader_responses` table)
  - [`src/backend/analytics/`](../src/backend/analytics/) post-event/post-stats
  - [`src/backend/actions/`](../src/backend/actions/) session + learning record server actions
- Frontend
  - [`src/app/`](../src/app/) Next.js App Router pages and layouts
  - [`src/components/`](../src/components/) UI components (Shadcn + feature UIs), [`ConvexProvider.tsx`](../src/components/ConvexProvider.tsx)
  - [`src/frontend/observable/`](../src/frontend/observable/) Legend/state stores: `sessions.ts`, `librarys.ts`
  - [`src/frontend/dexie/`](../src/frontend/dexie/) IndexedDB via Dexie (Note: Check current structure)
  - [`src/lib/`](../src/lib/) types, utilities, config
  - [`src/lib/convex/`](../src/lib/convex/) Convex client, hooks, sync helpers

## State management: Legend/state

You'll see observables like `session$`, `library$`, and `store$`.

- [`src/frontend/observable/sessions.ts`](../src/frontend/observable/sessions.ts) manages session identity and "local vs sync" choice. It persists to localStorage and reconciles with server session via server actions when configured.

**Real example from the codebase**:

```typescript
// From src/frontend/observable/sessions.ts
export const session$ = observable<Session>({
  anonymous: true,
  authenticated: false,
  lastActive: Date.now(),
  useConvex: false, // Default to false for backward compatibility
});
```

- [`src/frontend/observable/librarys.ts`](../src/frontend/observable/librarys.ts) manages student library. It conditionally persists:
  - Local mode: persist to localStorage
  - Sync mode: sends/receives via server actions or Convex (feature flag)
- [`src/frontend/observable/stores.ts`](../src/frontend/observable/stores.ts) holds UI state and treatment selections

Legend/state gives reactive `get/peek/assign` APIs and plugin-based persistence (`ObservablePersistLocalStorage`).

## Client persistence: Dexie (IndexedDB)

- [`src/frontend/dexie/db.ts`](../src/frontend/dexie/db.ts) defines IndexedDB tables for fluency records and cached assets.
- [`src/frontend/dexie/cached-assets.ts`](../src/frontend/dexie/cached-assets.ts) implements cache lifecycle (session logging, pruning stale assets, usage stats). This is performance-oriented offline caching.
- [`src/frontend/dexie/fluency-helpers.ts`](../src/frontend/dexie/fluency-helpers.ts) provides helper functions for fluency data management.
- [`src/frontend/dexie/sync.ts`](../src/frontend/dexie/sync.ts) handles synchronization logic.

Dexie is used for heavier/offline local data that doesn't fit well in localStorage.

## Server & audit: Drizzle ORM

- [`src/backend/db/schema.ts`](../src/backend/db/schema.ts) defines the `reader_responses` audit table
- [`src/backend/db/fluency-records.ts`](../src/backend/db/fluency-records.ts) shows querying/inserting via Drizzle with window functions
- [`drizzle.config.ts`](../drizzle.config.ts) wires schema + db credentials

The audit trail captures learning responses for analytics/traceability independent of the working set.

## Convex integration

- Schema: [`convex/schema.ts`](../convex/schema.ts) defines `libraries`, `learningRecords`, `preferences`
- Functions: [`convex/library.ts`](../convex/library.ts), [`convex/learning.ts`](../convex/learning.ts), [`convex/preferences.ts`](../convex/preferences.ts)
- Client:
  - [`src/components/ConvexProvider.tsx`](../src/components/ConvexProvider.tsx) supplies the Convex client to React
  - [`src/lib/convex/client.ts`](../src/lib/convex/client.ts) creates the client and provides a temporary auth token fetcher ([`/api/convex/token`](../src/app/api/convex/token/route.ts))
  - [`src/lib/convex/hooks.ts`](../src/lib/convex/hooks.ts) wraps generated API into ergonomic React hooks
  - [`src/lib/convex/sync.ts`](../src/lib/convex/sync.ts) helper methods to read/write via Convex or fallback
- Feature flag & availability:
  - Set `session$.saveProgress` to "sync" and `session.useConvex` to true to favor Convex
  - If `NEXT_PUBLIC_CONVEX_URL` is missing, code gracefully falls back to legacy methods

Auth is currently a development placeholder; production should replace [`/api/convex/token`](../src/app/api/convex/token/route.ts) with a real JWT via `auth.sara.ai`.

## API Endpoints

The application includes several Next.js API routes in [`src/app/api/`](../src/app/api/):

- [`/api/ping`](../src/app/api/ping/route.ts) - Health check endpoint for connectivity testing
- [`/api/session`](../src/app/api/session/route.ts) - Get current session information
- [`/api/student/new`](../src/app/api/student/new/route.ts) - Create new student sessions
- [`/api/errors`](../src/app/api/errors/route.ts) - Client-side error reporting system
- [`/api/learning-audit`](../src/app/api/learning-audit/route.ts) - Background sync for learning records audit
- [`/api/convex/token`](../src/app/api/convex/token/route.ts) - Generate authentication tokens for Convex

**Example API usage**:

```typescript
// From src/app/api/ping/route.ts
export async function GET() {
  return NextResponse.json({
    status: "ok",
    timestamp: new Date().toISOString(),
    server: "read-by-ear-api",
  });
}
```

For a comprehensive guide to all API endpoints, see [`docs/api-tutorial.md`](api-tutorial.md).

## Choosing local vs sync

- Local mode: No remote sync. Library/preferences persist to localStorage (and Dexie for specific data)
- Sync mode: Uses server actions by default; if `useConvex` and Convex URL present, uses Convex working set for realtime queries and mutations

Decision logic lives in [`src/lib/convex/sync.ts`](../src/lib/convex/sync.ts) (`shouldUseConvex`) and [`src/frontend/observable/librarys.ts`](../src/frontend/observable/librarys.ts).

## Example: follow a bookmark update

1. Component calls `useAddBookmark` (Convex) or updates `library$` (local)
2. In Convex mode, mutation hits `convex/library.ts:addBookmark`, which upserts bookmark and timestamps it
3. `useLibrary` (query) streams updated data; a timestamp field is converted to `Date` in the hook
4. In local mode, `library$` persists to localStorage and components react to observable changes

## Exercises and deeper dives

Continue with `docs/hands-on-exercises.md` for step-by-step labs and `docs/convex-primer.md` for a gentle introduction to Convex.

## Troubleshooting

See `docs/troubleshooting.md` for common issues (Convex URL missing, token errors, Dexie clearing, Drizzle connectivity).

---

If something doesn't match the code you're reading, search for the path mentioned above—every section ties back to concrete files in this repository.

---

**Next Tutorial**: [Data Flow Guide](./02-data-flow.md)
